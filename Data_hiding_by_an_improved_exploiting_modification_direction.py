# 创建时间 : 2024/2/20/0020 16:21
# 作者 : 金有朋
# 邮箱 : 3021927598@qq.com
# 文件名 : Data_hiding_by_an_improved_exploiting_modification_direction.py
# 编写人员：金有朋
#
# 开发时间：2024/2/8 20:34
import math
from PIL import Image


def plus(string):
    # Python zfill() 方法返回指定长度的字符串，原字符串右对齐，前面填充0。

    return string.zfill(8)


def mod(x, y):
    return x % y


def get_key(n, mode, str2):  # 进制转换，str1=0 表示n进制转二进制，str=1 表示二进制转n进制 str2进制字符串
    s = ""
    if mode == 0:
        i = int(str2, n)
        k = bin(i).replace('0b', '')
        s = str(k)
        print(str2, "\n", n, "进制转2进制：", s)
        return s
    elif mode == 1:
        i = int(str2, 2)
        print("i=", i)
        while i > 0:
            k = i % n
            i = i // n
            s += str(k)
        print(str2, "二进制转n进制:", s[::-1], )
        return s[::-1]


codebook = {0: [0, 0], 8: [-1, -2],  # n=2 x=2
            1: [1, 0], 9: [0, -2],
            2: [-1, 1], 10: [-2, -1],
            3: [0, 1], 11: [-1, -1],
            4: [1, 1], 12: [0, -1],
            5: [2, 1], 13: [1, -1],
            6: [0, 2], 14: [-1, 0],
            7: [1, 2], }
codebook2 = {0: [0, 0], 16: [-3, -2],  # n=2 x=3
             1: [1, 0], 17: [-2, -2],
             2: [2, 0], 18: [-1, -2],
             3: [3, 0], 19: [0, -2],
             4: [-2, 1], 20: [1, -2],
             5: [-1, 1], 21: [-2, -2],
             6: [0, 1], 22: [-3, -1],
             7: [1, 1], 23: [-2, -1],
             8: [2, 1], 24: [-1, -1],
             9: [3, 1], 25: [0, -1],
             10: [-2, 2], 26: [1, -1],
             11: [-1, 2], 27: [2, -1],
             12: [0, 2], 28: [-3, 0],
             13: [1, 2], 29: [-2, 0],
             14: [2, 2], 30: [-1, 0],
             15: [3, 2], }


# 隐藏函数
def func(str1, str2, str3, n, x):
    im2 = Image.open(str1)
    # 转换成灰度图
    im = im2.convert('L')
    # 获取图片的宽和高
    width = im.size[0]
    print("width:" + str(width) + "\n")
    height = im.size[1]
    print("height:" + str(height) + "\n")
    count = 0
    # 获取需要隐藏的信息
    key = get_key(5, 1, str2)  # key是转换n进制后的值
    # 隐藏信息长度
    keylen = len(key)
    print("len=", keylen)
    for h in range(0, height):

        for w in range(0, width, 2):
            pixel1 = im.getpixel((w, h))  # 第i位置的像数值
            pixel2 = im.getpixel((w + 1, h))  # 第i+1位置的像素值
            # print("w", w, 'w+1', w + 1)
            if count == keylen:
                break
            # 计算f值
            f = mod((pixel1 * 1 + pixel2 * 6), 31)
            d = int(key[count])
            print("\n", "f=", f, "pixel1=", pixel1, "pixel2", pixel2, "d=", d, )
            if d >= f:
                s = d - f
                print("d >= f s=", s)
            elif d < f and n >= 2:
                s = 2 ** (n + x) - 1 - math.fabs(d - f)
                print("d < f and n >= 2 s=", s)

            pixel1 += codebook2[s][0]
            pixel2 += codebook2[s][1]
            if pixel1 > 255 or pixel2 > 255:
                pixel1 -= 2 ** (n + x) - 1
                pixel2 -= 2 ** (n + x) - 1
            elif pixel1 < 0 or pixel2 < 0:
                pixel1 += 2 ** (n + x) - 1
                pixel2 += 2 ** (n + x) - 1
            print("NEW: pixel1=", pixel1, "pixel2", pixel2, "\n")
            im.putpixel((w + 1, h), pixel2)
            im.putpixel((w, h), pixel1)
            count += 1
        if count == keylen:
            break

    # im.show()
    im.save(str3)


# 提取函数
def func2(le, str1):
    im = Image.open(str1)

    width = im.size[0]

    height = im.size[1]
    str2 = ""
    count = 0
    for h in range(0, height):

        for w in range(0, width, 2):
            if count == le:
                break
            pixel1 = im.getpixel((w, h))  # 第i位置的像数值
            pixel2 = im.getpixel((w + 1, h))  # 第i+1位置的像素值
            # 计算f值
            f = mod((pixel1 * 1 + pixel2 * 6), 31)
            str2 += str(f)
            count += 1
            if count == le:
                print("str2=", str2)
                print("所求原二进制数据=", get_key(5, 0, str2))
                break


# 原图
old = "D:\programing\python\python-works\复现\Data_hiding_by_an_improved_exploiting_modificat\dog.png"
# 处理后输出的图片路径
new = "D:\programing\python\python-works\复现\Data_hiding_by_an_improved_exploiting_modificat\dog_test.png"
# 需要隐藏的信息
enc = "D:\programing\python\python-works\复现\Data_hiding_by_an_improved_exploiting_modificat\info.txt"

func(old, '110101101001', new, 2, 3)
func2(6, new)
